# -*- coding: utf-8 -*-
"""Untitled26.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1cWFtAFOXtrvuZwYlqoTsGrryhMcT050q
"""

#!pip install openai streamlit
import streamlit as st
from datetime import date, timedelta
import sqlite3
import openai

# =========================
# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ OpenAI API Ù…Ù† Streamlit Secrets
# =========================
try:
    openai.api_key = st.secrets["OPENAI_API_KEY"]
except KeyError:
    st.error("âš ï¸ Ù…ÙØªØ§Ø­ OpenAI API ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Streamlit Secrets Ø¨Ø§Ø³Ù… 'OPENAI_API_KEY'.")
    st.stop()

# =========================
# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©
# =========================
st.set_page_config(
    page_title="Ø§Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ø°ÙƒÙŠ",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# =========================
# Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
# =========================
def init_db():
    conn = sqlite3.connect(":memory:")
    cur = conn.cursor()
    cur.executescript("""
    CREATE TABLE Students (
        StudentID INTEGER PRIMARY KEY AUTOINCREMENT,
        Username TEXT UNIQUE,
        Password TEXT,
        FullName TEXT,
        Department TEXT
    );
    CREATE TABLE Schedules (
        ScheduleID INTEGER PRIMARY KEY AUTOINCREMENT,
        StudentID INTEGER,
        Day TEXT,
        StartTime TEXT,
        EndTime TEXT,
        Subject TEXT,
        Room TEXT
    );
    CREATE TABLE Tasks (
        TaskID INTEGER PRIMARY KEY AUTOINCREMENT,
        StudentID INTEGER,
        Title TEXT,
        DueDate TEXT,
        EstHours REAL,
        Priority TEXT,
        Done INTEGER DEFAULT 0
    );
    """)
    return conn, cur

def seed_demo(cur):
    cur.execute("INSERT INTO Students (Username, Password, FullName, Department) VALUES (?,?,?,?)",
                ("ahmed","1234","Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯","Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³ÙˆØ¨"))
    today = date.today()
    cur.executemany("INSERT INTO Schedules (StudentID, Day, StartTime, EndTime, Subject, Room) VALUES (?,?,?,?,?,?)", [
        (1,"Ø§Ù„Ø£Ø­Ø¯","09:00","11:00","Ø¨Ø±Ù…Ø¬Ø©","A101"),
        (1,"Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","10:00","12:00","Ø±ÙŠØ§Ø¶ÙŠØ§Øª","B201"),
        (1,"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","11:00","13:00","Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ","A102"),
        (1,"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","09:00","11:00","ÙÙŠØ²ÙŠØ§Ø¡","C101"),
        (1,"Ø§Ù„Ø®Ù…ÙŠØ³","10:00","12:00","Ù†Ø¸Ù… ØªØ´ØºÙŠÙ„","C301")
    ])
    cur.executemany("INSERT INTO Tasks (StudentID, Title, DueDate, EstHours, Priority) VALUES (?,?,?,?,?)", [
        (1,"Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§ÙŠØ«ÙˆÙ†","%s"%(today + timedelta(days=3)),6.0,"High"),
        (1,"ÙˆØ§Ø¬Ø¨ Ø±ÙŠØ§Ø¶ÙŠØ§Øª","%s"%(today + timedelta(days=1)),2.0,"Medium"),
        (1,"Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ","%s"%(today + timedelta(days=7)),4.0,"Low"),
        (1,"ØªØ¬Ù‡ÙŠØ² Ù…Ø®ØªØ¨Ø± Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡","%s"%(today + timedelta(days=2)),3.0,"High")
    ])

# =========================
# Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
# =========================
def authenticate(cur, username, password):
    cur.execute("SELECT StudentID, FullName, Department FROM Students WHERE Username=? AND Password=?", (username, password))
    return cur.fetchone()

def fetch_schedule(cur, student_id):
    cur.execute("SELECT ScheduleID, Day, StartTime, EndTime, Subject, Room FROM Schedules WHERE StudentID=? ORDER BY Day, StartTime", (student_id,))
    return cur.fetchall()

def fetch_tasks(cur, student_id):
    cur.execute("SELECT TaskID, Title, DueDate, EstHours, Priority, Done FROM Tasks WHERE StudentID=? ORDER BY DueDate", (student_id,))
    return cur.fetchall()

def update_task_done(cur, task_id):
    cur.execute("UPDATE Tasks SET Done=1 WHERE TaskID=?", (task_id,))

def get_upcoming_tasks(tasks, days=3):
    now = date.today()
    return [t for t in tasks if not t[5] and now <= date.fromisoformat(t[2]) <= now+timedelta(days=days)]

def get_overdue_tasks(tasks):
    now = date.today()
    return [t for t in tasks if not t[5] and date.fromisoformat(t[2]) < now]

def summarize_week(schedule, tasks):
    today = date.today()
    week_end = today + timedelta(days=7)
    week_tasks = [t for t in tasks if today <= date.fromisoformat(t[2]) <= week_end and not t[5]]
    return week_tasks, schedule

def plan_study(tasks):
    plan = sorted([t for t in tasks if not t[5]], key=lambda x: (x[4], x[2]))
    return plan

def ask_gpt(prompt):
    # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ GPT Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    response = openai.chat.completions.create(
        model="gpt-4",
        messages=[{"role":"user","content":prompt}],
        temperature=0.5
    )
    return response.choices[0].message.content

# =========================
# Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# =========================
def main():
    st.title("ğŸ“˜ Ø§Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ø°ÙƒÙŠ")

    if "db_init" not in st.session_state:
        conn, cur = init_db()
        seed_demo(cur)
        conn.commit()
        st.session_state.conn = conn
        st.session_state.cur = cur
        st.session_state.db_init = True

    cur = st.session_state.cur

    # ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
    if "student" not in st.session_state:
        with st.form("login_form"):
            username = st.text_input("ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
            password = st.text_input("ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")
            submit = st.form_submit_button("Ø¯Ø®ÙˆÙ„")
            if submit:
                auth = authenticate(cur, username, password)
                if auth:
                    st.session_state.student = {
                        "id": auth[0],
                        "name": auth[1],
                        "dept": auth[2]
                    }
                    st.success(f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {auth[1]} ğŸ‘‹")
                else:
                    st.error("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
        return

    student_id = st.session_state.student["id"]
    st.subheader(f"Ù…Ø±Ø­Ø¨Ø§ {st.session_state.student['name']} â€” {st.session_state.student['dept']}")

    # Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø®Øµ
    if st.button("ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø®Øµ"):
        schedule = fetch_schedule(cur, student_id)
        tasks = fetch_tasks(cur, student_id)

        # Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ©
        st.write("### ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…")
        today = date.today()
        today_tasks = [t for t in tasks if date.fromisoformat(t[2]) == today and not t[5]]
        overdue = get_overdue_tasks(tasks)
        upcoming = get_upcoming_tasks(tasks)

        if overdue:
            for t in overdue:
                st.error(f"âŒ Ù…Ù‡Ù…Ø© Ù…ØªØ£Ø®Ø±Ø©: {t[1]} (ØªØ³Ù„ÙŠÙ…: {t[2]})")
        if upcoming:
            for t in upcoming:
                st.warning(f"âš ï¸ Ù…Ù‡Ù…Ø© Ù‚Ø±ÙŠØ¨Ø©: {t[1]} (ØªØ³Ù„ÙŠÙ…: {t[2]})")
        if today_tasks:
            st.info("ğŸ“Œ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…:")
            for t in today_tasks:
                st.write(f"- {t[1]} (ØªØ³Ù„ÙŠÙ…: {t[2]})")
        if not overdue and not upcoming and not today_tasks:
            st.success("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø¹Ø§Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…")

        # Ù…Ù„Ø®Øµ Ø£Ø³Ø¨ÙˆØ¹ÙŠ
        week_tasks, week_schedule = summarize_week(schedule, tasks)
        st.write("### ğŸ“Š Ù…Ù„Ø®Øµ Ø£Ø³Ø¨ÙˆØ¹ÙŠ")
        st.table(week_tasks)

        # Ø®Ø·Ø© Ø¯Ø±Ø§Ø³Ø© Ø°ÙƒÙŠØ©
        study_plan = plan_study(tasks)
        st.write("### ğŸ§  Ø®Ø·Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©")
        st.table(study_plan)

        # ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù‡Ø§Ù… ÙƒÙ…ÙƒØªÙ…Ù„Ø©
        st.write("### âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù‡Ø§Ù… ÙƒÙ…ÙƒØªÙ…Ù„Ø©")
        for t in tasks:
            if not t[5]:
                if st.button(f"ØªÙ… Ø¥Ù†Ø¬Ø§Ø²: {t[1]}", key=t[0]):
                    update_task_done(cur, t[0])
                    st.success(f"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©: {t[1]}")

    # Ø´Ø§Øª GPT ØªÙØ§Ø¹Ù„ÙŠ
    st.write("### ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ")
    user_question = st.text_input("Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ (Ù…Ø«Ø§Ù„: Ù…Ø§Ø°Ø§ Ù„Ø¯ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ)")
    if user_question:
        schedule = fetch_schedule(cur, student_id)
        tasks = fetch_tasks(cur, student_id)
        study_plan = plan_study(tasks)
        data_summary = f"Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨: {schedule}\nÙ…Ù‡Ø§Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: {tasks}\nØ®Ø·Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©: {study_plan}"
        prompt = f"Ø§Ù„Ø·Ø§Ù„Ø¨ Ø³Ø£Ù„: '{user_question}'\nÙ‡Ø°Ù‡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: {data_summary}\nØ£Ø¬Ø¨ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…ÙÙ‡ÙˆÙ…Ø© ÙˆÙ„Ø·ÙŠÙØ©."
        answer = ask_gpt(prompt)
        st.info(answer)

if __name__ == "__main__":
    main()
